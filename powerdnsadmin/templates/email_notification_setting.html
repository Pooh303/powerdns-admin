{% extends "base.html" %}
{% set active_page = "admin_settings" %}
{% block title %}<title>Email Notification Settings - {{ SITE_NAME }}</title>{% endblock %}

{% block dashboard_stat %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark">Email Notification Settings</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Email Notification Settings</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 col-sm-6 col-lg-4">
                    <form role="form" method="post" data-toggle="validator">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                        <div class="card card-outline card-primary shadow">
                            <div class="card-header">
                                <h3 class="card-title">Load Balancer Port Status Notifications</h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="form-group has-feedback">
                                    <label class="control-label" for="notification_emails">
                                        <i class="fas fa-envelope"></i> Notification Email Addresses
                                    </label>
                                    <div class="input-group">
                                        <input type="email" 
                                               class="form-control" 
                                               placeholder="Enter email address"
                                               name="notification_email" 
                                               id="notification_email"
                                               data-error="Please input a valid email address">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-primary" id="add_email">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                    <div id="email_list" class="mt-2">
                                        {% if notification_emails %}
                                            {% for email in notification_emails.split(',') %}
                                                {% if email.strip() %}
                                                    <div class="badge badge-info p-2 mr-2 mb-2">
                                                        {{ email.strip() }}
                                                        <button type="button" class="btn btn-sm btn-link text-white remove-email" data-email="{{ email.strip() }}">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <input type="hidden" name="notification_emails" id="notification_emails" value="{{ notification_emails or '' }}">
                                    <span class="help-block with-errors"></span>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <label class="control-label mb-3">
                                        <i class="fas fa-bell"></i> Notification Preferences
                                    </label>
                                    <div class="custom-control custom-checkbox mb-2">
                                        <input type="checkbox" 
                                               class="custom-control-input" 
                                               id="notify_port_up"
                                               name="notify_port_up" 
                                               {% if notify_port_up %}checked{% endif %}>
                                        <label class="custom-control-label" for="notify_port_up">
                                            Notify when port status changes to UP <i class="fas fa-arrow-up text-success"></i>
                                        </label>
                                    </div>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" 
                                               class="custom-control-input" 
                                               id="notify_port_down"
                                               name="notify_port_down" 
                                               {% if notify_port_down %}checked{% endif %}>
                                        <label class="custom-control-label" for="notify_port_down">
                                             Notify when port status changes to DOWN <i class="fas fa-arrow-down text-danger"></i>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-body -->
                            <div class="card-footer">
                                <button type="button" id="test_email" class="btn btn-info float-left" title="Test Email Settings">
                                    <i class="fas fa-paper-plane"></i>&nbsp;Send Test Email
                                </button>
                                <button type="submit" class="btn btn-primary float-right" title="Save Settings">
                                    <i class="fas fa-save"></i>&nbsp;Save Settings
                                </button>
                            </div>
                            <!-- /.card-footer -->
                        </div>
                        <!-- /.card -->
                    </form>
                </div>
                <!-- /.col -->

                <div class="col-12 col-sm-6 col-lg-8">
                    <div class="card card-outline card-secondary shadow">
                        <div class="card-header">
                            <h3 class="card-title">Email Notification Guide</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h5><i class="fas fa-info-circle"></i> Configure Email Notifications</h5>
                                <p>Set up email notifications for load balancer port status changes.</p>
                            </div>
                            <dl class="dl-horizontal">
                                <dt><i class="fas fa-envelope"></i> Email Addresses</dt>
                                <dd>Enter one or more email addresses that should receive notifications. Each address should be on a new line.</dd>
                                
                                <dt><i class="fas fa-bell"></i> Notification Types</dt>
                                <dd>Choose which port status changes should trigger notifications:</dd>
                                <ul>
                                    <li><strong>Port UP:</strong> Receive notifications when a port becomes available</li>
                                    <li><strong>Port DOWN:</strong> Receive notifications when a port becomes unavailable</li>
                                </ul>
                                
                                <dt><i class="fas fa-paper-plane"></i> Test Email</dt>
                                <dd>Use the "Send Test Email" button to verify your email settings are working correctly.</dd>
                            </dl>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
{% endblock %}

{% block extrascripts %}
    {% assets "js_validation" -%}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {%- endassets %}
    <script>
        $(document).ready(function() {
            // Function to update hidden input with all emails
            function updateEmailList() {
                var emails = new Set(); // Use Set to ensure uniqueness
                $('#email_list .badge').each(function() {
                    emails.add($(this).text().trim());
                });
                $('#notification_emails').val(Array.from(emails).join(','));
            }

            // Function to add email
            function addEmail() {
                var email = $('#notification_email').val().trim();
                if (email && isValidEmail(email)) {
                    // Check if email already exists
                    var exists = false;
                    $('#email_list .badge').each(function() {
                        if ($(this).text().trim() === email) {
                            exists = true;
                            return false;
                        }
                    });

                    if (!exists) {
                        var badge = $('<div class="badge badge-info p-2 mr-2 mb-2">' +
                            email +
                            '<button type="button" class="btn btn-sm btn-link text-white remove-email" data-email="' + email + '">' +
                            '<i class="fas fa-times"></i>' +
                            '</button>' +
                            '</div>');
                        $('#email_list').append(badge);
                        $('#notification_email').val('');
                        updateEmailList();
                    } else {
                        alert('This email is already in the list');
                    }
                } else {
                    alert('Please enter a valid email address');
                }
            }

            // Initialize email list from saved values
            var savedEmails = $('#notification_emails').val();
            if (savedEmails) {
                var emailSet = new Set(); // Use Set to ensure uniqueness
                savedEmails.split(',').forEach(function(email) {
                    email = email.trim();
                    if (email) {
                        emailSet.add(email);
                    }
                });
                
                // Clear existing badges
                $('#email_list').empty();
                
                // Add unique emails as badges
                emailSet.forEach(function(email) {
                    var badge = $('<div class="badge badge-info p-2 mr-2 mb-2">' +
                        email +
                        '<button type="button" class="btn btn-sm btn-link text-white remove-email" data-email="' + email + '">' +
                        '<i class="fas fa-times"></i>' +
                        '</button>' +
                        '</div>');
                    $('#email_list').append(badge);
                });
                
                // Update hidden input with unique emails
                $('#notification_emails').val(Array.from(emailSet).join(','));
            }

            // Add email on button click
            $('#add_email').click(addEmail);

            // Add email on Enter key press
            $('#notification_email').keypress(function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault(); // Prevent form submission
                    addEmail();
                }
            });

            // Remove email
            $(document).on('click', '.remove-email', function() {
                $(this).parent().remove();
                updateEmailList();
            });

            // Email validation
            function isValidEmail(email) {
                var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            // Test email button
            $('#test_email').click(function() {
                var notificationEmails = $('#notification_emails').val();
                
                if (!notificationEmails) {
                    alert('Please add at least one email address');
                    return;
                }
                
                // Show loading state
                var $btn = $(this);
                var originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>&nbsp;Sending...');
                
                $.ajax({
                    url: "{{ url_for('admin.email_notification_setting') }}",
                    type: 'POST',
                    data: {
                        notification_emails: notificationEmails,
                        test_email: true,
                        _csrf_token: "{{ csrf_token() }}"
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            alert('Test emails sent successfully to all addresses!');
                        } else if (response.status === 'partial') {
                            alert('Test emails partially sent: ' + response.message);
                        } else {
                            alert('Failed to send test emails: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var errorMsg = 'Failed to send test emails';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        alert(errorMsg);
                    },
                    complete: function() {
                        // Reset button state
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });
    </script>
{% endblock %}
