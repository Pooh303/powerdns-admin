{% extends "base.html" %}
{% set active_page = "nav-item load_balance_dashboard" %}
{% block title %}<title>Load Balancer - {{ SITE_NAME }}</title>{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block head_meta %}
    {{ super() }}
    {# Assuming csrf_token() is available globally or from base.html context #}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
{% endblock %}


{% block dashboard_stat %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark">Load Balancer Dashboard</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Load Balancer</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- {# Flash messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="row">
                <div class="col-12">
                    {# ADDED 'flash-message-auto-close' class HERE #}
                    <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible flash-message-auto-close">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                        <h5>
                            {% if category == 'success' %}<i class="icon fas fa-check"></i> Success!
                            {% elif category == 'error' or category == 'danger' %}<i class="icon fas fa-ban"></i> Error!
                            {% elif category == 'warning' %}<i class="icon fas fa-exclamation-triangle"></i> Warning!
                            {% else %}<i class="icon fas fa-info"></i> Info
                            {% endif %}
                        </h5>
                        {{ message }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %} -->

        <div class="row mb-3 align-items-center">
            <div class="col-md-3"> {# Search Bar #}
                <div class="input-group">
                    <input type="text" id="lbSearchInput" class="form-control" placeholder="Search...">
                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="button" id="clearLbSearch" title="Clear Search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-2"> {# Status Filter #}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="lbStatusFilterSelect">Status</label>
                    </div>
                    <select class="custom-select" id="lbStatusFilterSelect">
                        <option value="all" selected>All</option>
                        <option value="active">Active</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2"> {# Sort By Field #}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="lbSortFieldSelect">Sort By</label>
                    </div>
                    <select class="custom-select" id="lbSortFieldSelect">
                        <option value="name" selected>Domain</option>
                        <option value="zone">Zone</option> {# Changed from "domain" to "zone" for clarity #}
                        <option value="status">Status</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2"> {# Sort Direction #}
                <div class="input-group">
                     <div class="input-group-prepend">
                        <label class="input-group-text" for="lbSortDirectionSelect">Order</label>
                    </div>
                    <select class="custom-select" id="lbSortDirectionSelect">
                        <option value="asc" selected>Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3 text-right"> {# Create Button #}
                <button type="button" id="updateStatusBtn" class="btn btn-info ml-2">
                    <i class="fas fa-sync-alt"></i> Update Status
                </button>
                {% if SETTING.get('allow_user_create_load_balance') or current_user.role.name in ['Administrator', 'Operator'] %}
                <a href="{{ url_for('load_balance.add') }}" class="btn btn-primary" style="margin-left: 0.5rem !important;">
                    <i class="fa-solid fa-plus"></i> New Load Balancer
                </a>
                {% endif %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf_token">
            </div>
        </div>

        {% if load_balancers %}
            <div class="row mb-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <a data-toggle="collapse" href="#statusGuide" role="button" aria-expanded="false" aria-controls="statusGuide" class="text-dark d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-info-circle mr-2"></i>Status Guide 
                                    <i class="fas fa-chevron-down"></i></span>
                                </a>
                            </h5>
                        </div>
                        <div class="collapse" id="statusGuide">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-active p-2 mr-2">Active</span>
                                            <span>Load balancer is operational and serving traffic normally</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-warning p-2 mr-2">Warning</span>
                                            <span>Load balancer is operational but has some issues that need attention</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-error p-2 mr-2">Error</span>
                                            <span>Load balancer is not operational and requires immediate attention</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-inactive p-2 mr-2">Inactive</span>
                                            <span>Load balancer is disabled and not serving traffic</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-pending p-2 mr-2">Pending</span>
                                            <span>Load balancer is being configured or waiting for activation</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge badge-status-updating p-2 mr-2">Updating</span>
                                            <span>Load balancer status is being updated</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id="loadBalancerCardContainer">
                {% for lb in load_balancers %}
                <div class="col-md-4 col-lg-3 mb-4 lb-card-entry"
                     id="{{ lb.html_id }}"
                     data-name="{{ lb.name | lower }}"
                     data-zone="{{ lb.zone_display_name | lower }}"
                     data-status="{{ lb.status | lower }}">
                    <div class="card h-100 shadow-sm lb-card lb-status-{{ lb.status | lower }}">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fa-solid fa-network-wired mr-2"></i><strong class="lb-name">{{ lb.name }}</strong>
                            </h5>
                            <div class="card-tools">
                                {% if current_user.role.name in ['Administrator', 'Operator'] %}
                                <div class="custom-control custom-switch d-inline-block mr-2">
                                    <input type="checkbox" class="custom-control-input lb-toggle-status" 
                                           id="lbToggle{{ lb.html_id }}"
                                           data-html-id="{{ lb.html_id }}"
                                           data-zone-name-dotted="{{ lb.zone_actual_name }}"
                                           data-record-name-dotted="{{ lb.record_actual_name }}"
                                           data-current-status="{{ lb.status | lower }}"
                                           {% if lb.status | lower != 'inactive' %}checked{% endif %}>
                                    <label class="custom-control-label" for="lbToggle{{ lb.html_id }}"></label>
                                </div>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-tool p-0 ml-2 copy-url-btn"
                                        data-url="{{ lb.name }}"
                                        title="Copy URL">
                                    <i class="fas fa-fw fa-copy"></i>
                                </button>
                                <div class="dropdown d-inline-block">
                                    <button class="btn btn-sm btn-tool dropdown-toggle" type="button" id="lbActions{{ lb.html_id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="lbActions{{ lb.html_id }}">
                                        <a class="dropdown-item" href="{{ url_for('load_balance.view', zone_name_dotted=lb.zone_actual_name, record_name_dotted=lb.record_actual_name) }}"><i class="fas fa-eye mr-2"></i>View Details</a>
                                        {% if current_user.role.name in ['Administrator', 'Operator'] %}
                                        <a class="dropdown-item" href="{{ url_for('load_balance.edit', zone_name_dotted=lb.zone_actual_name, record_name_dotted=lb.record_actual_name) }}"><i class="fas fa-edit mr-2"></i>Edit</a>
                                        <div class="dropdown-divider"></div>
                                        <button type="button" class="dropdown-item text-danger lb-delete-button"
                                                data-html-id="{{ lb.html_id }}"
                                                data-zone-name-dotted="{{ lb.zone_actual_name }}"
                                                data-record-name-dotted="{{ lb.record_actual_name }}"
                                                data-lbname="{{ lb.name }}">
                                            <i class="fas fa-trash-alt mr-2"></i>Delete
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-1">
                                <small class="text-muted">Zone: </small><label class="lb-zone small">{{ lb.zone_display_name }}</label>
                                <a href="{{ url_for('domain.domain', domain_name=lb.zone_actual_name.rstrip('.')) }}" class="btn btn-sm btn-tool p-0 ml-2" title="Open Zone {{ lb.zone_display_name }}">
                                <i class="fa fa-external-link-alt"></i></a>
                            </p>
                            <p class="card-text mb-1">
                                <small class="text-muted">Config:</small> <span class="lb-config">{{ lb.config_summary }}</span>
                            </p>

                            <p class="card-text mt-2">
                                <strong>Status:</strong>
                                <span class="badge badge-status-{{ lb.status | lower }} p-2 lb-status-text" ...>
                                    {{ lb.status | title }}
                                </span>
                                <br>
                                <small class="text-muted lb-status-detailed-message">{{ lb.status_message }}</small>
                            </p>

                            <!-- <p class="card-text mt-2">
                                <strong>Status:</strong>
                                    {% if lb.status | lower == 'updating' %}
                                        <i class="fa-solid fa-spinner fa-spin ml-1"></i>
                                    {% else %}
                                        <span class="badge badge-status-{{ lb.status | lower }} p-2 lb-status-text"
                                              data-toggle="tooltip"
                                              data-placement="top"
                                              title="{% if lb.status | lower == 'active' %}Load balancer is operational and serving traffic normally{% endif %}">
                                            {{ lb.status | title }}
                                        </span>
                                    {% endif %}
                                <br>
                                <small class="text-muted">{{ lb.status_message }}</small>
                            </p> -->

                            <!-- Server Status -->
                            {% if lb.server_statuses_list and lb.server_statuses_list | length > 0 %} {# Check the new list #}
                            <div class="mt-3">
                                <h6 class="mb-1"><strong>Backend Servers:</strong></h6>
                                <div class="table-responsive" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: .25rem;">
                                    <table class="table table-sm table-hover mb-0"> {# Removed table-striped if you don't want it #}
                                        <thead class="thead-light">
                                            <tr>
                                                <th scope="col" style="width: 70%;">IP Address</th>
                                                <th scope="col" class="text-center" style="width: 30%;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {# Loop through the ordered list #}
                                            {% for server_info in lb.server_statuses_list %}
                                            <tr>
                                                <td><i class="fas fa-server fa-fw mr-1 text-muted"></i>{{ server_info.ip }}</td>
                                                <td class="text-center">
                                                    {% if server_info.status == 'up' %}
                                                        <span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>UP</span>
                                                    {% elif server_info.status == 'down' %}
                                                        <span class="badge badge-danger"><i class="fas fa-times-circle mr-1"></i>DOWN</span>
                                                    {% else %}
                                                        <span class="badge badge-secondary">{{ server_info.status | upper if server_info.status else 'UNKNOWN' }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% else %}
                            <div class="mt-3">
                                <small class="text-muted">No individual server statuses available.</small>
                            </div>
                            {% endif %}

                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
             <div id="noLbResults" class="callout callout-warning" style="display: none;">
                <h4>No Matching Load Balancers</h4>
                <p>Your search did not match any load balancers.</p>
            </div>
        {% else %}
            <div class="callout callout-info">
                <h4>No Load Balancers Found</h4>
                <p>There are no load balancers configured yet.
                    {% if SETTING.get('allow_user_create_load_balance') or current_user.role.name in ['Administrator', 'Operator'] %}
                        You can <a href="{{ url_for('load_balance.add') }}">create one now</a>.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block head_styles %}
{{ super() }}
<style>
    .lb-status-active .card-header { background-color: #d4edda; border-bottom: 1px solid #c3e6cb; color: #155724; }
    .badge-status-active { background-color: #28a745; color: white; }
    .lb-status-warning .card-header { background-color: #fff3cd; border-bottom: 1px solid #ffeeba; color: #856404; }
    .badge-status-warning { background-color: #ffc107; color: #212529; }
    .lb-status-error .card-header { background-color: #f8d7da; border-bottom: 1px solid #f5c6cb; color: #721c24; }
    .badge-status-error { background-color: #dc3545; color: white; }
    .lb-status-inactive .card-header { background-color: #e2e3e5; border-bottom: 1px solid #d6d8db; color: #383d41; }
    .badge-status-inactive { background-color: #6c757d; color: white; }
    .lb-status-pending .card-header { background-color: #cce5ff; border-bottom: 1px solid #b8daff; color: #004085; }
    .badge-status-pending { background-color: #007bff; color: white; }
    /* .lb-status-updating .card-header { background-color: #e8f4f8; border-bottom: 1px solid #bee5eb; color: #0c5460; } */
    /* .badge-status-updating { background-color: #17a2b8; color: white; } */
    .badge-status-updating { background-color: #17a2b8; color: white; }
    .card-title strong { font-weight: 600; }
    
    /* Toggle Switch Styles */
    .custom-switch {
        padding-left: 2.5rem;
        margin-right: -0.5rem !important ;
        vertical-align: middle;
    }
    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #28a745;
        border-color: #28a745;
    }
    /* .custom-control-input:not(:checked) ~ .custom-control-label::before {
        background-color: #6c757d;
        border-color: #6c757d;
    } */
    .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
    }
    .custom-control-input:disabled ~ .custom-control-label::before {
        background-color: #e9ecef;
    }
    .card-tools {
        display: flex;
        align-items: center;
    }
    .card-tools .custom-switch {
        margin-top: 0;
    }

    .flash-message-auto-close {
    transition: opacity 0.5s ease-out, transform 0.5s ease-out, max-height 0.5s ease-out, padding-top 0.5s ease-out, padding-bottom 0.5s ease-out, margin-bottom 0.5s ease-out;
    overflow: hidden;
    opacity: 1;
    transform: translateY(0);
    max-height: 200px;
    }

    .flash-message-auto-close.fade-out {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block extrascripts %}
{{ super() }}
<script>
$(document).ready(function() {
    $('#statusGuide').on('show.bs.collapse', function () {
        $(this).prev().find('i.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    }).on('hide.bs.collapse', function () {
        $(this).prev().find('i.fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
    });

    $('.flash-message-auto-close').each(function() {
        var $alert = $(this);
        var closeDelay = 5000;
        var transitionDuration = 500;
        if ($alert.hasClass('alert-success')) {
            closeDelay = 3000;
        } else if ($alert.hasClass('alert-danger') || $alert.hasClass('alert-error')) {
            closeDelay = 7000;
        } else if ($alert.hasClass('alert-warning')) {
            closeDelay = 6000;
        }
        setTimeout(function() {
            $alert.addClass('fade-out');
            setTimeout(function() {
                $alert.remove();
            }, transitionDuration);
        }, closeDelay);
    });

    $('[data-toggle="tooltip"]').tooltip();

    const updateStatusBtn = document.getElementById('updateStatusBtn');
    if (updateStatusBtn) {
        updateStatusBtn.addEventListener('click', function() {
            const button = this;
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || document.querySelector('input[name="csrf_token"]')?.value;
            if (!csrfToken) {
                alert('Security token missing. Please refresh the page and try again.');
                button.disabled = false;
                button.innerHTML = originalContent;
                return;
            }
            const headers = {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': csrfToken,
                'X-CSRFToken': csrfToken,
                'X-Csrf-Token': csrfToken
            };
            fetch('{{ url_for("load_balance.update_status") }}', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ csrf_token: csrfToken }),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 403) throw new Error('You do not have permission to update load balancer statuses.');
                    return response.text().then(text => {
                        try { throw new Error(JSON.parse(text).msg || `Server error: ${response.status}`); }
                        catch (e) { throw new Error(`Server error: ${response.status} - ${text || response.statusText}`); }
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') window.location.reload();
                else throw new Error(data.msg || 'Failed to update status');
            })
            .catch(error => {
                alert(error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
            });
        });
    }

    const searchInput = document.getElementById('lbSearchInput');
    const statusFilterSelect = document.getElementById('lbStatusFilterSelect');
    const sortFieldSelect = document.getElementById('lbSortFieldSelect');
    const sortDirectionSelect = document.getElementById('lbSortDirectionSelect');
    const cardContainer = document.getElementById('loadBalancerCardContainer');
    const noResultsMessage = document.getElementById('noLbResults');
    const clearSearchButton = document.getElementById('clearLbSearch');
    let originalCards = cardContainer ? Array.from(cardContainer.getElementsByClassName('lb-card-entry')) : [];
    const statusCriticalityOrder = { 'error': 1, 'warning': 2, 'active': 3, 'pending': 4, 'inactive': 5, 'default': 6 };

    function applyFiltersAndSort() {
        if (!cardContainer) return;
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = statusFilterSelect.value.toLowerCase();
        const sortField = sortFieldSelect.value;
        const sortDirection = sortDirectionSelect.value;
        let filteredCards = originalCards.filter(card => {
            const name = card.dataset.name.toLowerCase();
            const zone = card.dataset.zone.toLowerCase();
            const status = card.dataset.status.toLowerCase();
            const matchesSearch = name.includes(searchTerm) || zone.includes(searchTerm);
            const matchesStatus = statusFilter === 'all' || status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        filteredCards.sort((a, b) => {
            let aValue, bValue;
            if (sortField === 'status') {
                aValue = statusCriticalityOrder[a.dataset.status] || statusCriticalityOrder.default;
                bValue = statusCriticalityOrder[b.dataset.status] || statusCriticalityOrder.default;
            } else {
                aValue = a.dataset[sortField].toLowerCase();
                bValue = b.dataset[sortField].toLowerCase();
            }
            return sortDirection === 'asc' ? (aValue > bValue ? 1 : -1) : (aValue < bValue ? 1 : -1);
        });
        cardContainer.innerHTML = '';
        filteredCards.forEach(card => cardContainer.appendChild(card));
        if (noResultsMessage) noResultsMessage.style.display = filteredCards.length === 0 ? 'block' : 'none';
    }

    if (searchInput) searchInput.addEventListener('input', applyFiltersAndSort);
    if (statusFilterSelect) statusFilterSelect.addEventListener('change', applyFiltersAndSort);
    if (sortFieldSelect) sortFieldSelect.addEventListener('change', applyFiltersAndSort);
    if (sortDirectionSelect) sortDirectionSelect.addEventListener('change', applyFiltersAndSort);
    if (clearSearchButton) clearSearchButton.addEventListener('click', function() {
        if (searchInput) { searchInput.value = ''; applyFiltersAndSort(); }
    });

    const deleteModalElement = document.getElementById('modal_lb_delete');
    const confirmDeleteButtonInModal = document.getElementById('button_lb_delete_confirm');
    const confirmLbNameInput = document.getElementById('confirmLbNameInputInModal');
    const lbNameToDeletePrompt = document.getElementById('lbNameToDeleteInModalPrompt');
    const lbDeleteErrorText = document.getElementById('lbDeleteErrorTextInModal');
    let dataForLbDeletion = null;

    if (deleteModalElement && confirmDeleteButtonInModal && confirmLbNameInput && lbNameToDeletePrompt && lbDeleteErrorText) {
        const bsDeleteModal = new bootstrap.Modal(deleteModalElement);
        document.querySelectorAll('.lb-delete-button').forEach(button => {
            button.addEventListener('click', function() {
                dataForLbDeletion = {
                    htmlId: this.dataset.htmlId,
                    zoneNameDotted: this.dataset.zoneNameDotted,
                    recordNameDotted: this.dataset.recordNameDotted,
                    lbName: this.dataset.lbname
                };
                $(deleteModalElement).find('.modal-title').text(`Delete Load Balancer: ${dataForLbDeletion.lbName}`);
                $(lbNameToDeletePrompt).text(`"${dataForLbDeletion.lbName}"`);
                // $(confirmLbNameInput).attr('placeholder', `Type "${dataForLbDeletion.lbName}" to confirm`);
                confirmLbNameInput.value = '';
                confirmDeleteButtonInModal.disabled = true;
                lbDeleteErrorText.style.display = 'none';
                bsDeleteModal.show();
            });
        });

        confirmLbNameInput.addEventListener('input', function() {
            if (dataForLbDeletion) {
                const typedName = this.value.trim();
                const expectedName = dataForLbDeletion.lbName.trim();
                if (typedName.toLowerCase() === expectedName.toLowerCase()) {
                    confirmDeleteButtonInModal.disabled = false;
                    lbDeleteErrorText.style.display = 'none';
                } else {
                    confirmDeleteButtonInModal.disabled = true;
                }
            }
        });
        
        confirmDeleteButtonInModal.addEventListener('click', function() {
            if (!dataForLbDeletion) return;
            const typedName = confirmLbNameInput.value.trim();
            const expectedName = dataForLbDeletion.lbName.trim();
            if (typedName.toLowerCase() !== expectedName.toLowerCase()) {
                lbDeleteErrorText.textContent = 'Name does not match.';
                lbDeleteErrorText.style.display = 'block';
                confirmLbNameInput.focus();
                return;
            }
            const button = this;
            const originalButtonText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            fetch(`/load-balance/delete/${dataForLbDeletion.zoneNameDotted}/${dataForLbDeletion.recordNameDotted}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content 
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => { throw new Error(errData.msg || `Server error: ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    const cardToRemove = document.getElementById(dataForLbDeletion.htmlId);
                    if (cardToRemove) {
                        cardToRemove.remove();
                        originalCards = originalCards.filter(card => card.id !== dataForLbDeletion.htmlId);
                        applyFiltersAndSort();
                    }
                    bsDeleteModal.hide();
                    showGlobalSuccess(`Load balancer "${dataForLbDeletion.lbName}" deleted successfully.`);
                } else {
                    throw new Error(data.msg || 'Failed to delete load balancer.');
                }
            })
            .catch(error => {
                showGlobalError(`Error deleting: ${error.message}`);
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalButtonText;
                confirmLbNameInput.value = '';
                lbDeleteErrorText.style.display = 'none';
                dataForLbDeletion = null;
            });
        });
    }

    document.querySelectorAll('.copy-url-btn').forEach(button => {
        button.addEventListener('click', function() {
            const urlToCopy = this.getAttribute('data-url');
            const iconElement = this.querySelector('i.fas.fa-fw');
            if (!urlToCopy) return;
            const copyToClipboardWithFallback = (text) => {
                return new Promise((resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(resolve).catch(err => tryFallback(text, resolve, reject));
                    } else {
                        tryFallback(text, resolve, reject);
                    }
                });
            };
            const tryFallback = (text, resolve, reject) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed'; textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try { if (document.execCommand('copy')) resolve(); else reject(new Error('Fallback failed.')); }
                catch (err) { reject(err); }
                finally { document.body.removeChild(textArea); }
            };
            copyToClipboardWithFallback(urlToCopy).then(() => {
                if (iconElement) { iconElement.classList.remove('fa-copy'); iconElement.classList.add('fa-check', 'text-success'); }
                this.setAttribute('title', 'Copied!'); $(this).tooltip('hide').tooltip('show');
                setTimeout(() => { if (iconElement) { iconElement.classList.remove('fa-check', 'text-success'); iconElement.classList.add('fa-copy'); } this.setAttribute('title', 'Copy URL'); $(this).tooltip('hide').tooltip('show'); }, 2000);
            }).catch(err => {
                this.setAttribute('title', 'Copy failed!'); $(this).tooltip('hide').tooltip('show');
                showGlobalError('Failed to copy URL to clipboard.');
                setTimeout(() => { this.setAttribute('title', 'Copy URL'); $(this).tooltip('hide').tooltip('show');}, 2000);
            });
        });
    });

    function showGlobalError(message) {
        if (typeof toastr !== 'undefined') toastr.error(message, 'Error');
        else console.error("Global Error:", message);
    }
    function showGlobalSuccess(message) {
        if (typeof toastr !== 'undefined') toastr.success(message, 'Success');
        else console.info("Global Success:", message);
    }

    document.querySelectorAll('.lb-toggle-status').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const cardElementId = this.dataset.htmlId;
            const zoneNameDotted = this.dataset.zoneNameDotted;
            const recordNameDotted = this.dataset.recordNameDotted;
            const newStatus = this.checked ? 'active' : 'disabled';
            const currentToggle = this; currentToggle.disabled = true;
            const card = document.getElementById(cardElementId);
            if (card) card.classList.add('lb-status-updating');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || document.querySelector('input[name="csrf_token"]')?.value;
            if (!csrfToken) {
                alert('Security token missing. Please refresh and try again.');
                currentToggle.disabled = false; if (card) card.classList.remove('lb-status-updating'); return;
            }
            fetch(`/load-balance/toggle-status/${zoneNameDotted}/${recordNameDotted}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-CSRF-Token': csrfToken, 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ status: newStatus, _csrf_token: csrfToken })
            })
            .then(response => { if (!response.ok) throw new Error(`Server error: ${response.status}`); return response.json(); })
            .then(data => {
                if (data.status === 'ok') {
                    showGlobalSuccess(`Load balancer ${newStatus === 'active' ? 'enabled' : 'disabled'} successfully`);
                    if (card) {
                        card.classList.add('lb-status-updating');
                        const statusBadge = card.querySelector('.lb-status-text');
                        if (statusBadge) { statusBadge.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...'; statusBadge.style.backgroundColor = '#17a2b8'; statusBadge.style.color = 'white'; }
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else { throw new Error(data.msg || 'Failed to update status'); }
            })
            .catch(error => { showGlobalError(error.message); currentToggle.checked = !currentToggle.checked; })
            .finally(() => { currentToggle.disabled = false; if (card) card.classList.remove('lb-status-updating'); });
        });
    });
    
    const REALTIME_UPDATE_INTERVAL = 5000;
    function updateCardStatus(cardElement, lbData) {
        if (!cardElement) return;
        const statusBadge = cardElement.querySelector('.lb-status-text');
        const detailedMessageElement = cardElement.querySelector('.lb-status-detailed-message');
        cardElement.classList.remove('lb-status-active', 'lb-status-warning', 'lb-status-error', 'lb-status-inactive', 'lb-status-pending', 'lb-status-updating');
        cardElement.classList.add(`lb-status-${lbData.status.toLowerCase()}`);
        cardElement.dataset.status = lbData.status.toLowerCase();
        if (statusBadge) {
            statusBadge.className = 'badge p-2 lb-status-text';
            statusBadge.classList.add(`badge-status-${lbData.status.toLowerCase()}`);
            statusBadge.textContent = lbData.status.charAt(0).toUpperCase() + lbData.status.slice(1);
            statusBadge.setAttribute('title', lbData.status_message);
        }
        if (detailedMessageElement) detailedMessageElement.textContent = lbData.status_message;
        const serverTableBody = cardElement.querySelector('.table-responsive tbody');
        if (serverTableBody) {
            serverTableBody.innerHTML = '';
            if (lbData.server_statuses_list && lbData.server_statuses_list.length > 0) {
                for (const server of lbData.server_statuses_list) {
                    const ip = server.ip;
                    const status = server.status;
                    let statusBadgeHtml = '';
                    if (status === 'up') {
                        statusBadgeHtml = '<span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>UP</span>';
                    } else if (status === 'down') {
                        statusBadgeHtml = '<span class="badge badge-danger"><i class="fas fa-times-circle mr-1"></i>DOWN</span>';
                    } else {
                        statusBadgeHtml = `<span class="badge badge-secondary">${status ? status.toUpperCase() : 'UNKNOWN'}</span>`;
                    }
                    const row = `<tr><td><i class="fas fa-server fa-fw mr-1 text-muted"></i>${ip}</td><td class="text-center">${statusBadgeHtml}</td></tr>`;
                    serverTableBody.innerHTML += row;
                }
            } else {
                serverTableBody.innerHTML = '<tr><td colspan="2"><small class="text-muted">No individual server statuses available.</small></td></tr>';
            }
        }
    }

    function fetchAndUpdateLbStatuses() {
        fetch('{{ url_for("load_balance.realtime_status") }}')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 403) { return null; }
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.load_balancers) {
                    data.load_balancers.forEach(lbData => {
                        const cardElement = document.getElementById(lbData.html_id);
                        if (cardElement && !cardElement.classList.contains('lb-status-updating')) {
                            updateCardStatus(cardElement, lbData);
                        }
                    });
                    applyFiltersAndSort(); 
                }
            })
            .catch(error => {
                console.error('Error fetching real-time LB statuses:', error);
            });
    }

    if (cardContainer && originalCards.length > 0) {
        applyFiltersAndSort();
        setInterval(fetchAndUpdateLbStatuses, REALTIME_UPDATE_INTERVAL);
    }
});
</script>
{% endblock %}

{% block modals %}
{{ super() }}
<div class="modal fade modal-danger" id="modal_lb_delete" tabindex="-1" role="dialog" aria-labelledby="modalLbDeleteLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLbDeleteLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <p>You are about to delete the load balancer. This action cannot be undone.</p>
                <div class="form-group mt-3">
                    <label for="confirmLbNameInputInModal">To confirm, type <strong id="lbNameToDeleteInModalPrompt"></strong> in the box below:</label>
                    <!-- <input type="text" class="form-control" id="confirmLbNameInputInModal" placeholder="Type name to confirm" autocomplete="off"> -->
                     <input type="text" class="form-control" id="confirmLbNameInputInModal" autocomplete="off">
                    <small id="lbDeleteErrorTextInModal" class="form-text text-danger" style="display:none;">Name does not match.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fa-solid fa-window-close"></i> Cancel</button>
                <button type="button" class="btn btn-danger" id="button_lb_delete_confirm" disabled><i class="nav-icon fa-solid fa-trash-alt"></i> Delete Load Balancer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}